<html lang="en"></html>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steve's Home Page</title>
</head>
<body>
    <h1>Daily Digest Brought to You by Steve</h1>

    <form id="accountForm" action="/submit" method="POST">
        <h2>Howdy, <span id='displayFirstname'></span>!</h2>
        <input type="text" id="username" name="username" class="input-field" placeholder="New Username">
        <input type="password" id="password" name="password" class="input-field" placeholder="New Password">
        <select id="dogBreed" name="dogBreed">
            <option value="">--Change Dog Breed--</option>
        </select>
        <button type="button" class="button" onclick="changeUser()">Save Changes</button>
        <button type="button" class="button" onClick="window.location.href='/'">Back</button>
    </form>

    <script>
        window.onload = function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.firstname) {
                document.getElementById('displayFirstname').innerText = currentUser.firstname;
            } else {
                document.getElementById('displayFirstname').innerText = 'Guest'
            }
            fetchBreeds();
        }

        function fetchBreeds() {
            const breedSelect = document.getElementById('dogBreed');
            fetch('https://dog.ceo/api/breeds/list/all')
            .then(response => response.json())
            .then(data => {
                const breeds = data.message;
                for (const breed in breeds) {
                    if (breeds.hasOwnProperty(breed)) {
                        const breedName = capitalizeEachWord(breed);
                        if (breeds[breed].length > 0) {
                            breeds[breed].forEach(subBreed => {
                                const subBreedName = capitalizeEachWord(subBreed)
                                const option = document.createElement('option');
                                option.value = `${breed}/${subBreed}`;
                                option.text = `${breedName} ${subBreedName}`;
                                breedSelect.appendChild(option);
                            });
                        } else {
                            const option = document.createElement('option');
                            option.value = breed;
                            option.text = breedName;
                            breedSelect.appendChild(option);
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching breed list:', error);
            })
        }

        function capitalizeEachWord(string) {
            return  string.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
        }

        function changeUser() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const newUsername = document.getElementById('username').value.trim();
            const newPassword = document.getElementById('password').value.trim();
            const newDogBreed = document.getElementById('dogBreed').value.trim();

            if (currentUser) {
               if (newUsername) {
                const usernameExists = users.some(user => user.username === newUsername && user.username !== currentUser.username);
                if (usernameExists) {
                    alert("This username is already taken. Please use another usernmane and try again");
                    return;
                }
                currentUser.username = newUsername;
               }
               if (newPassword) {
                currentUser.password = newPassword;
               }

               if (newDogBreed) {
                currentUser.dogBreed = newDogBreed;
               }

                const userIndex = users.findIndex(user => user.username === currentUser.username);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    alert("User information updated succesfully!");
                } else {
                    alert("Error: User not found")
                    console.error('Error updating account settings: User not found')
                }                
            } else {
                alert("Error saving your account settings, please try again");
                console.error('Error updating account settings:', error)
            }
            window.location.href="/";
        }
    </script>
</body>
</html>